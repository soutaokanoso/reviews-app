<!DOCTYPE html>
<html lang="ja">
<head>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6054223868978259"
     crossorigin="anonymous"></script>
    <meta charset="UTF-8">
    <title>団体を探す</title>
    <meta name="google-site-verification" content="I-6pXdZ-8O-kBGU7J5imtft81pLgAJFzc2GvGoYzVC0" />
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #e6f7ff;
            color: #333;
            margin: 0;
            padding: 40px 20px;
            text-align: center;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
        }
        #searchInput {
            width: 70%;
            padding: 12px 20px;
            margin: 8px 0;
            display: inline-block;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px;
        }
        #searchButton {
            background-color: #0077cc;
            color: white;
            padding: 14px 20px;
            margin-left: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        #suggestions {
            border: 1px solid #ccc;
            border-top: none;
            max-height: 150px;
            overflow-y: auto;
            position: absolute;
            width: 70%;
            z-index: 100;
            background-color: white;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
        }
        #suggestions div {
            padding: 10px;
            cursor: pointer;
            text-align: left;
        }
        #suggestions div:hover {
            background-color: #f1f1f1;
        }
        .review-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            text-align: left;
        }
        hr {
            border-top: 1px solid #ccc;
            margin-top: 20px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>海外ボランティア団体を探す</h2>
    <p>団体名を入力してください</p>
    <div style="position: relative; display: inline-block; width: 100%;">
        <input type="text" id="searchInput" placeholder="例: ジャパンハート, 日本赤十字...">
        <div id="suggestions"></div>
    </div>
    <button id="searchButton">検索</button>
    
    <div id="searchResults">
        </div>
</div>

<script>
    const searchInput = document.getElementById('searchInput');
    const searchButton = document.getElementById('searchButton');
    const suggestionsDiv = document.getElementById('suggestions');
    const searchResultsDiv = document.getElementById('searchResults');
    let allOrganizations = [];

    // 評価項目の日本語訳を定義
    const ratingsMap = {
      interactive_children: '子どもとの交流',
      interactive_people: '現地の人との交流',
      education_language: '言語支援',
      education_sports: 'スポーツ支援',
      education_music: '音楽支援',
      welfare_medical: '医療サポート',
      welfare_elderly: '高齢者サポート',
      welfare_disabilities: '障がい者サポート',
      environment_forest: '植林活動、森林保護',
      environment_animal: '動物保護',
      environment_sea: '海洋保護',
      environment_clean: '清掃',
      environment_agricluture: '農業',
      poverty_food: '食事配膳',
      culture_history: '歴史地訪問',
      culture_experience: '文化体験',
      culture_event: 'イベント参加',
      culture_town: '町おこし',
      infra_reconstruction: '復興',
      infra_water: '井戸掘り、水道整備',
      infra_electricity: '電気整備',
      infra_traffic: '交通整備',
      infra_construction: '建設',
      meal_local: '食事（現地らしさ）',
      meal_japanese: '食事（日本人の口に合うか）',
      language_speak: '現地語を話す必要',
      language_guide: '日本語ガイドの有無',
      private: '個人的な関わり',
      official: '団体としての関わり',
      freedom: '自由度',
      support: '航空券や入国などの援助'
    };

    // 評価をグループごとに取得するヘルパー関数
    function getRatingsByGroup(review, groupKeys) {
      return groupKeys.map(key => {
        const value = review.ratings[key];
        return value && value !== '未回答' ? `<li><b>${ratingsMap[key]}</b>: ${value} / 5</li>` : '';
      }).join('');
    }

    // すべての団体名をサーバーから取得する関数
    async function fetchAllOrganizations() {
        try {
            const response = await fetch('/organizations');
            const data = await response.json();
            allOrganizations = data;
        } catch (error) {
            console.error('Error fetching organizations:', error);
        }
    }

    // 入力に基づいてサジェストを表示
    searchInput.addEventListener('input', () => {
        const query = searchInput.value.toLowerCase();
        suggestionsDiv.innerHTML = '';
        if (query.length < 2) {
            return;
        }

        const filtered = allOrganizations.filter(org => org.toLowerCase().includes(query));
        
        filtered.forEach(org => {
            const div = document.createElement('div');
            div.textContent = org;
            div.addEventListener('click', () => {
                searchInput.value = org;
                suggestionsDiv.innerHTML = '';
            });
            suggestionsDiv.appendChild(div);
        });
    });

    // 検索ボタンのクリックイベント
    searchButton.addEventListener('click', async () => {
        const query = searchInput.value;
        if (!query) return;

        try {
            const response = await fetch(`/search?organization=${encodeURIComponent(query)}`);
            const reviews = await response.json();
            displayResults(reviews);
        } catch (error) {
            console.error('Error searching:', error);
            searchResultsDiv.innerHTML = '<p>検索中にエラーが発生しました。</p>';
        }
    });

    // 検索結果を表示する関数
    function displayResults(reviews) {
        if (reviews.length === 0) {
            searchResultsDiv.innerHTML = '<p>該当する団体は見つかりませんでした。</p>';
            return;
        }

        const html = reviews.map(r => {
            const activityKeys = [
                'interactive_children', 'interactive_people', 'education_language', 'education_sports', 'education_music', 
                'welfare_medical', 'welfare_elderly', 'welfare_disabilities', 'environment_forest', 'environment_animal', 
                'environment_sea', 'environment_clean', 'environment_agricluture', 'poverty_food', 'culture_history', 
                'culture_experience', 'culture_event', 'culture_town', 'infra_reconstruction', 'infra_water', 
                'infra_electricity', 'infra_traffic', 'infra_construction'
            ];
            const mealKeys = ['meal_local', 'meal_japanese'];
            const languageKeys = ['language_speak', 'language_guide'];
            const otherKeys = ['private', 'official', 'freedom', 'support'];
            
            const activityHtml = getRatingsByGroup(r, activityKeys);
            const mealHtml = getRatingsByGroup(r, mealKeys);
            const languageHtml = getRatingsByGroup(r, languageKeys);
            const otherRatingsHtml = getRatingsByGroup(r, otherKeys);

            const stayHtml = (r.stay || []).map(s => {
                const japaneseStay = {
                    hotel: 'ホテル',
                    dormitory: '団体専用寮',
                    homestay: 'ホームステイ'
                }[s] || s;
                return `<li>${japaneseStay}</li>`;
            }).join('');

            const reasonHtml = (r.reason || []).map(re => {
                const japaneseReason = {
                    school: '学校の授業関連',
                    overseas: '海外に行ってみたかった',
                    challenging: '何かに挑戦してみたかった',
                    children: '子供が好きだった',
                    volunteer: 'ボランティアに興味があった',
                    international: '国際問題に興味があった',
                    poor: '貧困問題に興味があった',
                    friend: '友達の紹介'
                }[re] || re;
                return `<li>${japaneseReason}</li>`;
            }).join('');

            const japanesePeriod = {
                oneweek: '1週間以内',
                twoweek: '1-2週間',
                onemonth: '2週間-1カ月',
                threemonth: '1-3カ月',
                sixmonth: '3-6カ月',
                oneyear: '6カ月-1年',
                long: '1年以上'
            }[r.period] || r.period;

            const japaneseNationality = {
                japanese_only: '日本人のみ',
                japanese_local: '日本人と現地人',
                multinational: '多国籍'
            }[r.nationality] || r.nationality;
            
            return `<div class="review-card">
              <hr>
              <b>参加者情報</b>
              <ul>
                <li>職業: ${r.occ || '未記入'}</li>
                <li>所属: ${r.belong || '未記入'}</li>
                <li>年齢: ${r.age || '未記入'}</li>
                <li>性別: ${r.gender || '未記入'}</li>
                <li>参加理由: <ul>${reasonHtml}</ul></li>
              </ul>
              <b>団体情報</b>
              <ul>
                <li>参加団体: ${r.organization || '未記入'}</li>
                <li>参加回: ${r.time || '未記入'}</li>
                <li>参加時期: ${r.seoson || '未記入'}</li>
                <li>参加期間: ${japanesePeriod || '未記入'}</li>
                <li>参加国: ${r.country || '未記入'}</li>
                <li>参加者数: ${r.people || '未記入'}</li>
                <li>男女比: ${r.genderRatio || '未記入'}</li>
                <li>参加者国籍: ${japaneseNationality || '未記入'}</li>
                <li>参加費: ${r.cost || '未記入'}</li>
                <li>この団体を選んだ理由: ${r.reason2 || '未記入'}</li>
              </ul>
              <b>活動内容</b>
              <ul>${activityHtml}</ul>
              <b>食事</b>
              <ul>${mealHtml}</ul>
              <b>宿泊施設</b>
              <ul>${stayHtml}</ul>
              <b>言語力</b>
              <ul>${languageHtml}</ul>
              <b>その他</b>
              <ul>${otherRatingsHtml}</ul>
              
              <br>
              <b>感想</b>
              <ul>
                <li>おすすめポイント: ${r.appeal || '未記入'}</li>
                <li>改善ポイント: ${r.improve || '未記入'}</li>
                <li>感想: ${r.comment || '未記入'}</li>
                <li>おすすめ度: ${r.recommendation || '未記入'} / 10</li>
              </ul>
            </div>`;
        }).join('');
        searchResultsDiv.innerHTML = html;
    }

    // ページロード時に団体名を取得
    fetchAllOrganizations();
</script>

</body>
</html>