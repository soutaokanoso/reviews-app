<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>口コミ一覧</title>
  <meta name="google-site-verification" content="I-6pXdZ-8O-kBGU7J5imtft81pLgAJFzc2GvGoYzVC0" />
  <style>
    body {
        font-family: Arial, sans-serif;
        line-height: 1.6;
        padding: 20px;
        background-color: #f4f4f4;
    }
    .review-container {
        background: #fff;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .helpful-button {
        background-color: #0077cc;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
    }
    .helpful-button:hover {
        background-color: #005a9c;
    }
    .helpful-count {
        margin-left: 10px;
        font-weight: bold;
    }
    </style>
</head>
<body>
  <h1>口コミ一覧</h1>
  <div id="reviewsList"></div>

  <script>
    const reviewsList = document.getElementById('reviewsList');
    const urlParams = new URLSearchParams(window.location.search);
    const isAdmin = urlParams.get('admin') === 'true';

    // 評価項目の日本語訳を定義
    const ratingsMap = {
      // 交流
      interactive_children: '子どもとの交流',
      interactive_people: '現地の人との交流',
      // 教育
      education_language: '言語支援',
      education_sports: 'スポーツ支援',
      education_music: '音楽支援',
      // 医療・福祉
      welfare_medical: '医療サポート',
      welfare_elderly: '高齢者サポート',
      welfare_disabilities: '障がい者サポート',
      // 環境
      environment_forest: '植林活動、森林保護',
      environment_animal: '動物保護',
      environment_sea: '海洋保護',
      environment_clean: '清掃',
      environment_agricluture: '農業',
      // 貧困
      poverty_food: '食事配膳',
      // 文化
      culture_history: '歴史地訪問',
      culture_experience: '文化体験',
      culture_event: 'イベント参加',
      culture_town: '町おこし',
      // 災害・インフラ
      infra_reconstruction: '復興',
      infra_water: '井戸堀り、水道整備',
      infra_electricity: '電気整備',
      infra_traffic: '交通整備',
      infra_construction: '建設',
      // 食事
      meal_local: '食事（現地らしさ）',
      meal_japanese: '食事（日本人の口に合うか）',
      // 言語力
      language_speak: '現地語を話す必要',
      language_guide: '日本語ガイドの有無',
      // その他
      private: '個人的な関わり',
      official: '団体としての関わり',
      freedom: '自由度',
      support: '航空券や入国などの援助'
    };

    // 評価をグループごとに取得するヘルパー関数
    function getRatingsByGroup(review, groupKeys) {
      return groupKeys.map(key => {
        const value = review.ratings[key];
        return value && value !== '未回答' ? `<li><b>${ratingsMap[key]}</b>: ${value} / 5</li>` : '';
      }).join('');
    }

    async function loadReviews() {
      const res = await fetch('/reviews');
      const reviews = await res.json();
      
      reviewsList.innerHTML = reviews.map(r => {
        // 各評価グループの項目を定義
        const activityKeys = [
          'interactive_children', 'interactive_people', 'education_language', 'education_sports', 'education_music', 
          'welfare_medical', 'welfare_elderly', 'welfare_disabilities', 'environment_forest', 'environment_animal', 
          'environment_sea', 'environment_clean', 'environment_agricluture', 'poverty_food', 'culture_history', 
          'culture_experience', 'culture_event', 'culture_town', 'infra_reconstruction', 'infra_water', 
          'infra_electricity', 'infra_traffic', 'infra_construction'
        ];
        const mealKeys = ['meal_local', 'meal_japanese'];
        const languageKeys = ['language_speak', 'language_guide'];
        const otherKeys = ['private', 'official', 'freedom', 'support'];
        
        // 各セクションのHTMLを生成
        const activityHtml = getRatingsByGroup(r, activityKeys);
        const mealHtml = getRatingsByGroup(r, mealKeys);
        const languageHtml = getRatingsByGroup(r, languageKeys);
        const otherRatingsHtml = getRatingsByGroup(r, otherKeys);

        const stayHtml = (r.stay || []).map(s => {
          const japaneseStay = {
            hotel: 'ホテル',
            dormitory: '団体専用寮',
            homestay: 'ホームステイ'
          }[s] || s;
          return `<li>${japaneseStay}</li>`;
        }).join('');

        const reasonHtml = (r.reason || []).map(re => {
          const japaneseReason = {
            school: '学校の授業関連',
            overseas: '海外に行ってみたかった',
            challenging: '何かに挑戦してみたかった',
            children: '子供が好きだった',
            volunteer: 'ボランティアに興味があった',
            international: '国際問題に興味があった',
            poor: '貧困問題に興味があった',
            friend: '友達の紹介'
          }[re] || re;
          return `<li>${japaneseReason}</li>`;
        }).join('');

        const japanesePeriod = {
            oneweek: '1週間以内',
            twoweek: '1-2週間',
            onemonth: '2週間-1カ月',
            threemonth: '1-3カ月',
            sixmonth: '3-6カ月',
            oneyear: '6カ月-1年',
            long: '1年以上'
        }[r.period] || r.period;

        const japaneseNationality = {
            japanese_only: '日本人のみ',
            japanese_local: '日本人と現地人',
            multinational: '多国籍'
        }[r.nationality] || r.nationality;
        
        const deleteButton = isAdmin ? `<button onclick="deleteReview('${r._id}')">削除</button>` : '';

        // 役立ったボタンとカウンターを追加
        const helpfulSection = `
            <div style="margin-top: 15px;">
                <button class="helpful-button" onclick="addHelpful('${r._id}')">
                    役に立った
                </button>
                <span class="helpful-count" id="helpful-count-${r._id}">
                    ${r.helpfulCount || 0}
                </span>
            </div>
        `;

        return `<div class="review-container">
          <b>参加者情報</b>
          <ul>
            <li>職業: ${r.occ || '未記入'}</li>
            <li>所属: ${r.belong || '未記入'}</li>
            <li>年齢: ${r.age || '未記入'}</li>
            <li>性別: ${r.gender || '未記入'}</li>
            <li>参加理由: <ul>${reasonHtml}</ul></li>
          </ul>
          <b>団体情報</b>
          <ul>
            <li>参加団体: ${r.organization || '未記入'}</li>
            <li>参加回: ${r.time || '未記入'}</li>
            <li>参加時期: ${r.seoson || '未記入'}</li>
            <li>参加期間: ${japanesePeriod || '未記入'}</li>
            <li>参加国: ${r.country || '未記入'}</li>
            <li>参加者数: ${r.people || '未記入'}</li>
            <li>男女比: ${r.genderRatio || '未記入'}</li>
            <li>参加者国籍: ${japaneseNationality || '未記入'}</li>
            <li>参加費: ${r.cost || '未記入'}</li>
            <li>この団体を選んだ理由: ${r.reason2 || '未記入'}</li>
            <li>宿泊施設: <ul>${stayHtml}</ul></li>
          </ul>
          <b>活動内容</b>
          <ul>${activityHtml}</ul>
          <br>
          <b>活動内容の詳細</b>
          <p>${r.activity_details || '未記入'}</p>
          <b>食事</b>
          <ul>${mealHtml}</ul>
          <b>宿泊施設</b>
          <ul>${stayHtml}</ul>
          <b>言語力</b>
          <ul>${languageHtml}</ul>
          <b>その他</b>
          <ul>${otherRatingsHtml}</ul>
          
          <br>
          <b>感想</b>
          <ul>
            <li>おすすめポイント: ${r.appeal || '未記入'}</li>
            <li>改善ポイント: ${r.improve || '未記入'}</li>
            <li>感想: ${r.comment || '未記入'}</li>
            <li>おすすめ度: ${r.recommendation || '未記入'} / 10</li>
          </ul>
          ${helpfulSection}
          ${deleteButton}
        </div>`;
      }).join('');
    }

    async function deleteReview(id) {
        if (!confirm('本当にこの口コミを削除しますか？')) {
            return;
        }

        try {
            const res = await fetch(`/reviews/${id}`, { method: 'DELETE' });
            if (res.ok) {
                alert('口コミを削除しました。');
                loadReviews();
            } else {
                alert('削除に失敗しました。');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('削除中にエラーが発生しました。');
        }
    }

    // 役立ったボタンのクリック処理を追加
    async function addHelpful(id) {
        try {
            const res = await fetch(`/reviews/helpful/${id}`, { method: 'POST' });
            if (res.ok) {
                // UIを即座に更新
                const countElement = document.getElementById(`helpful-count-${id}`);
                const currentCount = parseInt(countElement.textContent);
                countElement.textContent = currentCount + 1;
            } else {
                alert('カウントに失敗しました。');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('操作中にエラーが発生しました。');
        }
    }

    loadReviews();
  </script>

  <a href="write_review.html">口コミを書くページへ</a>
</body>
</html>